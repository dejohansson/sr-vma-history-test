<!DOCTYPE html>
<html>
  <head>
    <title>SR VMA Alerts ðŸ“¢</title>
    <script
      type="text/javascript"
      src="https://unpkg.com/vis-timeline@8.4.0/standalone/umd/vis-timeline-graph2d.min.js"
    ></script>
    <style>
      body {
        background-color: #202328;
        font-family: Arial, sans-serif;
        margin: 20px;
        height: 100vh;
        overflow: hidden;
      }

      #timeline {
        width: 100%;
        height: calc(100vh - 250px);
        border: 1px solid #2d2f35;
        background-color: #212429;
        overflow: hidden;
      }

      /* Timeline styling */
      .vis-timeline {
        border: none;
        background-color: #212429;
      }

      .vis-time-axis .vis-text {
        color: #c5d1e6;
        font-weight: 500;
      }

      .vis-time-axis .vis-grid.vis-minor {
        border-color: #2d2f35;
      }

      .vis-time-axis .vis-grid.vis-major {
        border-color: #52555a;
      }

      /* Item styling */
      .vis-item {
        background-color: #98a7c3;
        border-color: #98a7c3;
        color: #1a1c20;
        font-weight: 600;
        font-size: 24px;
      }

      .vis-item a {
        color: inherit;
        text-decoration: none;
      }

      .vis-item a:hover {
        color: inherit;
        text-decoration: none;
      }

      .vis-item a:visited {
        color: inherit;
      }

      .vis-item.alert-item {
        background-color: #e61f43;
        border-color: #c12745;
        color: #ffffff;
      }

      /* Panel styling */
      .vis-panel {
        background-color: #212429;
      }

      .vis-labelset .vis-label {
        color: #c5d1e6;
        border-color: #2d2f35;
        font-weight: 500;
      }

      /* Current time line */
      .vis-current-time {
        background-color: #4a9eff;
        width: 3px;
      }
    </style>
  </head>

  <body>
    <a
      id="latest-update-link"
      href=""
      target="_blank"
      style="
        display: block;
        margin-bottom: 30px;
        padding: 20px;
        border: 1px solid #2d2f35;
        background-color: #212429;
        border-radius: 8px;
        text-decoration: none;
        color: inherit;
      "
    >
      <div id="latest-update">
        <h2 style="margin: 0 0 15px 0; color: #c5d1e6; font-size: 28px">
          Latest VMA Update
        </h2>
        <div
          id="update-content"
          style="display: flex; align-items: center; gap: 15px"
        >
          <span id="update-emoji" style="font-size: 48px"></span>
          <div>
            <div
              id="update-type"
              style="font-size: 24px; font-weight: 600; margin-bottom: 5px"
            ></div>
            <div id="update-time" style="font-size: 16px; color: #c5d1e6"></div>
          </div>
        </div>
      </div>
    </a>

    <div id="timeline"></div>

    <script>
      const rawData = [
        { type: "quiet", datetime: "2025-11-21T01:18:35.000Z" },
        { type: "quiet", datetime: "2025-11-22T20:15:02.000Z" },
        { type: "quiet", datetime: "2025-11-23T08:30:38.000Z" },
        { type: "quiet", datetime: "2025-11-23T14:36:54.000Z" },
        { type: "quiet", datetime: "2025-11-23T20:45:47.000Z" },
        { type: "quiet", datetime: "2025-11-24T02:53:05.000Z" },
        { type: "alert", datetime: "2025-11-24T09:00:56.000Z" },
        { type: "quiet", datetime: "2025-11-24T15:08:00.000Z" },
        { type: "quiet", datetime: "2025-11-24T21:15:44.000Z" },
        { type: "alert", datetime: "2025-11-25T03:20:58.000Z" },
        { type: "quiet", datetime: "2025-11-25T09:29:40.000Z" },
        { type: "quiet", datetime: "2025-11-25T15:37:10.000Z" },
      ];
    </script>

    <script type="text/javascript">
      // Create a DataSet with items
      var items = new vis.DataSet(
        rawData.map((item, index) => {
          const fileName = `${item.datetime}_${item.type}.json`;
          const githubUrl = `https://github.com/dejohansson/sr-vma-history-test/blob/main/data/vma/${fileName}`;
          return {
            id: index + 1,
            content: `<a href="${githubUrl}" target="_blank"">${
              item.type === "quiet" ? "Quiet ðŸ˜´" : "Alert ðŸ“¢"
            }</a>`,
            start: item.datetime,
            className: item.type === "alert" ? "alert-item" : "",
          };
        })
      );

      const currentDate = new Date();

      // Configuration for the Timeline
      var options = {
        margin: {
          item: {
            horizontal: 100,
            vertical: 40,
          },
          axis: 40,
        },
        stack: true,
        orientation: "top",
        showCurrentTime: true,
        selectable: false,
        verticalScroll: true,
        moveable: true,
        zoomable: true,
        maxHeight: window.innerHeight - 250,
        start: new Date(currentDate.getTime() - 24 * 60 * 60 * 1000),
        end: new Date(currentDate.getTime() + 60 * 60 * 1000),
        cluster: {
          maxItems: 1,
          titleTemplate: "{count} Quiet ðŸ˜´",
          clusterCriteria: function (firstItem, secondItem) {
            // Only cluster quiet items together, never cluster alerts
            if (
              firstItem.className === "alert-item" ||
              secondItem.className === "alert-item"
            ) {
              return false;
            }
            return firstItem.className === secondItem.className;
          },
        },
        rollingMode: {
          follow: false,
          offset: 1 - 1 / 25,
        },
        zoomMin: 6 * 60 * 60 * 1000,
        zoomMax: 365 * 24 * 60 * 60 * 1000,
        min: new Date(
          new Date(rawData[0].datetime).getTime() - 30 * 24 * 60 * 60 * 1000
        ),
        max: new Date(
          currentDate.getFullYear(),
          currentDate.getMonth() + 1,
          currentDate.getDate()
        ),
      };

      // Populate latest update section
      const latestItem = rawData[rawData.length - 1];
      const updateEmoji = document.getElementById("update-emoji");
      const updateType = document.getElementById("update-type");
      const updateTime = document.getElementById("update-time");
      const latestUpdateLink = document.getElementById("latest-update-link");

      updateEmoji.textContent = latestItem.type === "quiet" ? "ðŸ˜´" : "ðŸ“¢";
      updateType.textContent = latestItem.type === "quiet" ? "Quiet" : "Alert";
      updateType.style.color =
        latestItem.type === "quiet" ? "#98a7c3" : "#e61f43";

      const date = new Date(latestItem.datetime);
      updateTime.textContent = date.toLocaleString("en-SE", {
        weekday: "long",
        year: "numeric",
        month: "long",
        day: "numeric",
        hour: "2-digit",
        minute: "2-digit",
        timeZoneName: "short",
      });

      const fileName = `${latestItem.datetime}_${latestItem.type}.json`;
      const githubUrl = `https://github.com/dejohansson/sr-vma-history-test/blob/main/data/vma/${fileName}`;
      latestUpdateLink.href = githubUrl;

      // Create a Timeline
      var container = document.getElementById("timeline");

      var timeline = new vis.Timeline(container, items, options);

      // Function to update cluster labels
      function updateClusterLabels() {
        setTimeout(function () {
          const clusterItems = document.querySelectorAll(
            ".vis-item.vis-cluster"
          );
          clusterItems.forEach(function (item) {
            const content = item.querySelector(".vis-item-content");
            if (content && content.textContent.match(/^\d+$/)) {
              const count = content.textContent;
              content.textContent = count + " Quiet " + "ðŸ˜´";
            }
          });
        }, 100);
      }

      // Update cluster labels on zoom and range change
      timeline.on("rangechanged", updateClusterLabels);
      timeline.on("changed", updateClusterLabels);

      // Initial update
      updateClusterLabels();

      // Update maxHeight on window resize
      window.addEventListener("resize", function () {
        timeline.setOptions({
          ...options,
          maxHeight: window.innerHeight - 250,
        });
      });
    </script>
  </body>
</html>
